name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

            # Log in to Docker Hub
            echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

            # Stop and remove old containers
            docker stop frontend || true && docker rm frontend || true
            docker stop backend || true && docker rm backend || true
            docker stop postgres || true && docker rm postgres || true

            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/backend-app:GHWF
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/frontend-app:GHWF

            # Create Docker network
            docker network inspect myapp-network >/dev/null 2>&1 || docker network create myapp-network

            # Start PostgreSQL container
            docker run -d \
              --name postgres \
              --network myapp-network \
              -e POSTGRES_USER=${{ secrets.POSTGRES_USER }} \
              -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
              -e POSTGRES_DB=${{ secrets.POSTGRES_DB }} \
              -v pgdata:/var/lib/postgresql/data \
              -p 5432:5432 \
              postgres:15

            # Start backend container
            docker run -d \
              --name backend \
              --network myapp-network \
              -p 8080:8080 \
              -e PG_HOST=postgres \
              -e PG_PORT=5432 \
              -e PG_USER=${{ secrets.POSTGRES_USER }} \
              -e PG_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
              -e PG_DATABASE=${{ secrets.POSTGRES_DB }} \
              -e DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public \
              ${{ secrets.DOCKER_HUB_USERNAME }}/backend-app:GHWF

            # Start frontend container
            docker run -d \
              --name frontend \
              --network myapp-network \
              -p 3000:80 \
              -e REACT_APP_SERVER_API_URL=http://backend:8080 \
              ${{ secrets.DOCKER_HUB_USERNAME }}/frontend-app:GHWF

          EOF
